<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to bamr package • bamr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to bamr package">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bamr</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/bamr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/bam-likelihood.html">Manning likelihood</a>
    </li>
    <li>
      <a href="../articles/error_structure.html">Specifying BAM error structure</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/markwh/bamr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Introduction to bamr package</h1>
                        <h4 class="author">Mark Hagemann</h4>
            
            <h4 class="date">2018-10-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/markwh/bamr/blob/master/vignettes/bamr.Rmd"><code>vignettes/bamr.Rmd</code></a></small>
      <div class="hidden name"><code>bamr.Rmd</code></div>

    </div>

    
    
<p>The <code>bamr</code> package facilitates Bayesian AMHG + Manning discharge estimation using stream slope, width, and partial cross-section area. It includes functions to preprocess and visualize data, perform Bayesian inference using Hamiltonian Monte Carlo (via models pre-written in the Stan language), and analyze the results.</p>
<p>This document illustrates its primary functionality by example. More information for individual functions can be found in the help pages, e.g. <code><a href="../reference/bam_data.html">?bam_data</a></code></p>
<div id="installing-and-loading-bamr" class="section level2">
<h2 class="hasAnchor">
<a href="#installing-and-loading-bamr" class="anchor"></a>Installing and loading <code>bamr</code>
</h2>
<p><code>bamr</code> is under active development, but a working version is available on Github. To install and load it requires the <code>devtools</code> package. To get all of this and load <code>bamr</code> simply run:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">"devtools"</span>)) {
  <span class="kw">install.packages</span>(<span class="st">"devtools"</span>)
}
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"markwh/bamr"</span>, <span class="dt">local =</span> <span class="ot">FALSE</span>)
<span class="kw">library</span>(<span class="st">"bamr"</span>)</code></pre></div>
</div>
<div id="example-dataset-from-sacramento-river" class="section level2">
<h2 class="hasAnchor">
<a href="#example-dataset-from-sacramento-river" class="anchor"></a>Example dataset from Sacramento River</h2>
<p>The <code>Sacramento</code> dataset included in <code>bamr</code> contains all data required to perform BAM estimation of discharge. (This is the Downstream Sacramento from Durand et al., 2016.) To attach the items it contains, run:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(Sacramento)
<span class="kw">attach</span>(Sacramento)</code></pre></div>
<p>This will put the following objects in your global environment:</p>
<ul>
<li>Sac_w: a matrix of widths (locations as rows, days as columns)</li>
<li>Sac_s: a matrix of slopes (locations as rows, days as columns)</li>
<li>Sac_dA: a matrix of partial areas (locations as rows, days as columns)</li>
<li>Sac_QWBM: a vector of water-balance-model discharge estimates for the days represented in the other matrices. This is required as a prior parameter for BAM. In this case, the estimates are all the same, representing the average water-balance-model discharge for the Sacramento, and could be supplied as a single number rather than a vector. But it is also possible to specify time-varying prior estimates.</li>
</ul>
</div>
<div id="preprocessing-data" class="section level2">
<h2 class="hasAnchor">
<a href="#preprocessing-data" class="anchor"></a>1. Preprocessing Data</h2>
<p>The <code>bam_data</code> function takes width, slope, partial area, and best-guess flow as arguments.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Sac_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bam_data.html">bam_data</a></span>(<span class="dt">w =</span> Sac_w, <span class="dt">s =</span> Sac_s, <span class="dt">dA =</span> Sac_dA, <span class="dt">Qhat =</span> Sac_QWBM)</code></pre></div>
<p>This returns an object of class “bamdata” that will be used to create prior parameters via <code><a href="../reference/bam_priors.html">bam_priors()</a></code> and perform Bayesian inference via <code><a href="../reference/bam_estimate.html">bam_estimate()</a></code>.</p>
<p>It is a good idea to plot the data; this can be done by simply calling</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/bam_plot.html">bam_plot</a></span>(Sac_data)</code></pre></div>
<p>As <code>bam_plot</code> returns a ggplot object, it can be modified, for example to make the y-axis be log scale:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw"><a href="../reference/bam_plot.html">bam_plot</a></span>(Sac_data) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_continuous">scale_y_log10</a></span>()</code></pre></div>
<div id="width-only-datasets" class="section level3">
<h3 class="hasAnchor">
<a href="#width-only-datasets" class="anchor"></a>Width-only datasets</h3>
<p>The AMHG-only BAM variant relies on width data only, and so it is possible to specify a <code>bamdata</code> object containing width-only data. (An <em>a priori</em> discharge estimate is still required.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Sac_amhg &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bam_data.html">bam_data</a></span>(<span class="dt">w =</span> Sac_w, <span class="dt">Qhat =</span> Sac_QWBM)

<span class="kw"><a href="../reference/bam_plot.html">bam_plot</a></span>(Sac_amhg)</code></pre></div>
</div>
</div>
<div id="specifying-prior-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#specifying-prior-parameters" class="anchor"></a>2. Specifying prior parameters</h2>
<p><strong>bamr</strong> uses a set of default prior parameters, which can be displayed by calling <code><a href="../reference/bam_settings.html">bam_settings()</a></code></p>
<p>Individual settings can also be queried by passing their name(s) to <code><a href="../reference/bam_settings.html">bam_settings()</a></code>, e.g.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/bam_settings.html">bam_settings</a></span>(<span class="st">"lowerbound_A0"</span>, <span class="st">"upperbound_A0"</span>)
<span class="kw"><a href="../reference/bam_settings.html">bam_settings</a></span>(<span class="st">"logQc_hat"</span>, <span class="st">"upperbound_logQ"</span>)</code></pre></div>
<p>(The <code>minmax</code> function used in the “upperbound_logQ” parameter takes the minimum in space of the maximum in time for each location.)</p>
<p>These settings are used to generate a set of BAM prior parameters for a particular analysis, using the <code>bam_priors</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Sac_priors &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bam_priors.html">bam_priors</a></span>(<span class="dt">bamdata =</span> Sac_data)</code></pre></div>
<p><code>bam_priors</code> has an additional optional argument, <code>variant</code>, which can be changed to select the BAM variant. This can be either <code>manning_amhg</code> (the default, which includes all parameters), <code>manning</code>, or <code>amhg</code>.</p>
<p>If you wish to use a different prior, you can specify it. For example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Sac_priors_mod1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bam_priors.html">bam_priors</a></span>(<span class="dt">bamdata =</span> Sac_data, <span class="dt">lowerbound_A0 =</span> <span class="dv">20</span>)</code></pre></div>
<p>Data-dependent priors can also be specified using unquoted expressions. Any variables referenced therein must be part of the object specified in the <code>bamdata</code> argument. For example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Sac_priors_mod2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bam_priors.html">bam_priors</a></span>(<span class="dt">bamdata =</span> Sac_data, 
                             <span class="dt">logQc_hat =</span> <span class="kw">median</span>(logQ_hat))</code></pre></div>
</div>
<div id="estimation-via-bayesian-inference" class="section level2">
<h2 class="hasAnchor">
<a href="#estimation-via-bayesian-inference" class="anchor"></a>3. Estimation via Bayesian inference</h2>
<p>Once data and priors have been established, we are ready to make BAM estimates using <code>bam_estimate</code>. Although this has been optimized as much as possible, it is still computationally intensive and may take on the order of several minutes to run, depending on the dataset. For the included <code>Sacramento</code> dataset it should be relatively quick (less than 30 seconds) assuming you are on a multicore machine.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Sac_man_amhg &lt;- bam_estimate(bamdata = Sac_data,</span>
<span class="co">#                        variant = "manning_amhg")</span></code></pre></div>
<p>Note that in this example I haven’t touched the <code>bam_priors</code> function. The default behavior for <code>bam_estimate</code> is to use <code>bampriors = bam_priors(bamdata)</code>, which uses the default priors as discussed above. An estimate using different priors (and using AMHG-only for estimation) could be performed using</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Sac_amhg &lt;- bam_estimate(bamdata = Sac_data, </span>
<span class="co">#                   bampriors = bam_priors(bamdata = Sac_data, </span>
<span class="co">#                                          upperbound_logQ = log(5000)),</span>
<span class="co">#                   variant = "amhg")</span></code></pre></div>
<p>or by passing a predefined <code>bampriors</code> object.</p>
<p>The third option for <code>variant</code> is “<code>manning</code>”, which uses Manning’s equation only.</p>
</div>
<div id="analyzing-results-" class="section level2">
<h2 class="hasAnchor">
<a href="#analyzing-results-" class="anchor"></a>4. Analyzing results.</h2>
<p>Once a BAM estimate has been computed, a hydrograph can be generated using <code>bam_hydrograph</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># bam_hydrograph(fit = Sac_man_amhg)</span>
<span class="co"># bam_hydrograph(fit = Sac_amhg)</span></code></pre></div>
<p>This displays posterior mean and 95% (by default; this can be adjusted) credible interval flows for all chains.</p>
<p>If you have observed flow (as we do for the Sacramento), you can plot this alongside using the optional <code>qobs</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># bam_hydrograph(fit = Sac_man_amhg, qobs = Sac_Qobs)</span></code></pre></div>
<p><code>bam_estimate</code> uses the <code>rstan</code> package to perform the Monte Carlo estimation, and returns an object of class <code>stanfit</code>. The <code>rstan</code> package contains additional functions for exploring the results, for example to see parameter convergence. See <code>vignette("stanfit-objects")</code> (from the <code>rstan</code> package) for more info on what you can do with these.</p>
<div id="validation" class="section level3">
<h3 class="hasAnchor">
<a href="#validation" class="anchor"></a>Validation</h3>
<p><code>bamr</code> currently has some basic functionality for validating flow estimates, in addition to the hydrographs already mentioned.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># val_manning_amhg &lt;- bam_validate(fit = Sac_man_amhg, qobs = Sac_Qobs)</span>

<span class="co"># prediction vs. observation</span>
<span class="kw"><a href="../reference/bam_plot.html">bam_plot</a></span>(val_manning_amhg)

<span class="co"># A suite of performance metrics</span>
val_manning_amhg<span class="op">$</span>stats</code></pre></div>
<p>If you want to calculate your own metrics, the <code><a href="../reference/bam_valdata.html">bam_valdata()</a></code> function might be useful. See its documentation for more info.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#installing-and-loading-bamr">Installing and loading <code>bamr</code></a></li>
      <li><a href="#example-dataset-from-sacramento-river">Example dataset from Sacramento River</a></li>
      <li><a href="#preprocessing-data">1. Preprocessing Data</a></li>
      <li><a href="#specifying-prior-parameters">2. Specifying prior parameters</a></li>
      <li><a href="#estimation-via-bayesian-inference">3. Estimation via Bayesian inference</a></li>
      <li><a href="#analyzing-results-">4. Analyzing results.</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Mark Hagemann.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
